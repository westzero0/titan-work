<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÏóÖÎ¨¥ Ïä§ÏºÄÏ§Ñ - ÏõîÍ∞Ñ</title>
    <style>
        :root { --bg: #f8f9fa; --white: #ffffff; --red: #ff4d4f; --blue: #007bff; --green: #e2fbe5; --text: #333; --border: #eee; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .nav-month { display: flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1rem; }
        .nav-btn { cursor: pointer; padding: 4px 10px; background: white; border: 1px solid var(--border); border-radius: 5px; font-size: 0.8rem; }
        
        .role-badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 12px; font-weight: bold; }
        .role-me { background: var(--green); color: #155724; border: 1px solid #a3cfbb; }
        .role-oppa { background: #cfe2ff; color: #084298; border: 1px solid #b6d4fe; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; max-width: 600px; background: var(--white); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .day-label { text-align: center; font-size: 0.65rem; color: #888; font-weight: 600; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .day-label:nth-child(7n+1) { color: var(--red); } /* ÏùºÏöîÏùº */
        
        .cell { position: relative; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); min-height: 85px; padding: 2px; display: flex; flex-direction: column; }
        .cell:nth-child(7n) { border-right: none; }
        .date-num { font-size: 0.75rem; font-weight: 600; margin-bottom: 2px; padding: 2px; }
        .is-holiday .date-num { color: var(--red); }
        .other-month { opacity: 0.2; pointer-events: none; }

        /* AM/PM Î≤ÑÌäº */
        .btn-group { display: flex; flex-direction: column; gap: 1px; margin-top: auto; z-index: 2; }
        button.status { border: 1px solid var(--border); border-radius: 3px; padding: 4px 0; font-size: 0.55rem; cursor: pointer; background: #fff; line-height: 1; }
        button.status-1 { background: var(--green) !important; color: #155724; border-color: #a3cfbb; font-weight: bold; }
        button.status-2 { background: var(--blue) !important; color: white; border-color: #0056b3; font-weight: bold; }

        /* Ïû•Í∏∞ ÏùºÏ†ï Î∞î(Event Bar) */
        .event-bar { position: absolute; left: 0; right: 0; height: 12px; color: white; font-size: 0.5rem; padding: 0 2px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; border-radius: 1px; z-index: 1; pointer-events: none; line-height: 12px; }
    </style>
</head>
<body>
    <header>
        <div class="nav-month">
            <div class="nav-btn" onclick="changeMonth(-1)">‚óÄ</div>
            <span id="current-month">2026.01</span>
            <div class="nav-btn" onclick="changeMonth(1)">‚ñ∂</div>
        </div>
        <div id="badge" class="role-badge">Î°úÎî©Ï§ë</div>
    </header>
    
    <div class="calendar-grid" id="calendar">
        <div class="day-label">Ïùº</div><div class="day-label">Ïõî</div><div class="day-label">Ìôî</div>
        <div class="day-label">Ïàò</div><div class="day-label">Î™©</div><div class="day-label">Í∏à</div><div class="day-label">ÌÜ†</div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby4b4qF3TgjlISH0cBlaEWlxJymbzxw4adNmWwRsT1EMQJq50tL9y43ZuHcsAdtD_ZF0Q/exec'; 
        const urlParams = new URLSearchParams(window.location.search);
        const user = urlParams.get('user') || 'me';
        let currentYear = 2026, currentMonth = 0; 

        // 2026ÎÖÑ Ï£ºÏöî Í≥µÌú¥Ïùº (ÏÑ§ÎÇ† Ïó∞Ìú¥ Ìè¨Ìï®)
        const holidays = ["2026-01-01", "2026-01-28", "2026-01-29", "2026-01-30", "2026-03-01", "2026-05-05", "2026-05-24", "2026-06-06", "2026-08-15", "2026-09-24", "2026-09-25", "2026-09-26", "2026-10-03", "2026-10-09", "2026-12-25"];

        async function init() {
            const badge = document.getElementById('badge');
            badge.innerText = user === 'me' ? "üôã‚Äç‚ôÄÔ∏è ÎÇ¥ ÏÑ§Ï†ï" : "üôã‚Äç‚ôÇÔ∏è Ïò§Îπ† ÌôïÏù∏";
            badge.className = `role-badge ${user === 'me' ? 'role-me' : 'role-oppa'}`;
            
            const now = new Date();
            currentYear = now.getFullYear();
            currentMonth = now.getMonth();
            await fetchData();
        }

        async function fetchData() {
            try {
                const res = await fetch(API_URL + "?t=" + new Date().getTime());
                const allData = await res.json();
                localStorage.setItem('full_data_cache', JSON.stringify(allData));
                render(allData);
            } catch (e) {
                const cached = localStorage.getItem('full_data_cache');
                if (cached) render(JSON.parse(cached));
            }
        }

        function render(allData) {
            document.getElementById('current-month').innerText = `${currentYear}.${(currentMonth + 1).toString().padStart(2, '0')}`;
            const container = document.getElementById('calendar');
            container.querySelectorAll('.cell').forEach(el => el.remove());

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            const prevLastDate = new Date(currentYear, currentMonth, 0).getDate();

            for (let i = firstDay - 1; i >= 0; i--) createCell(prevLastDate - i, true);
            for (let i = 1; i <= lastDate; i++) createCell(i, false, allData);
            const remaining = 42 - container.querySelectorAll('.cell').length;
            for (let i = 1; i <= remaining; i++) createCell(i, true);
        }

        function createCell(date, isOther, allData) {
            const cell = document.createElement('div');
            cell.className = `cell ${isOther ? 'other-month' : ''}`;
            const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}`;
            if (holidays.includes(dateStr)) cell.classList.add('is-holiday');
            cell.innerHTML = `<div class="date-num">${date}</div>`;
            
            if (!isOther && allData) {
                // AM/PM Î≤ÑÌäº Î†åÎçîÎßÅ (daily Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º)
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';
                ['AM', 'PM'].forEach(time => {
                    const id = `${dateStr}-${time}`;
                    const item = allData.daily.find(d => d.id === id) || { status: 0 };
                    const btn = document.createElement('button');
                    btn.className = `status status-${item.status}`;
                    btn.innerText = (time === 'AM' ? '‚òÄÔ∏è' : 'üåô') + (item.status === 2 ? ' ÌôïÏ†ï' : (item.status === 1 ? ' Í∞ÄÎä•' : ''));
                    btn.onclick = () => handleToggle(id, item.status, time, allData);
                    btnGroup.appendChild(btn);
                });
                cell.appendChild(btnGroup);

                // Ïû•Í∏∞ ÏùºÏ†ï Î∞î Î†åÎçîÎßÅ (events Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º)
                allData.events.forEach((ev, idx) => {
                    const s = new Date(ev.start); const e = new Date(ev.end);
                    const curr = new Date(dateStr);
                    if (curr >= s && curr <= e) {
                        const bar = document.createElement('div');
                        bar.className = 'event-bar';
                        bar.style.background = ev.color;
                        bar.style.top = (18 + idx * 14) + "px"; // Î∞î Í≤πÏπ® Î∞©ÏßÄ
                        if (curr.toDateString() === s.toDateString()) bar.innerText = ev.title;
                        cell.appendChild(bar);
                    }
                });
            }
            document.getElementById('calendar').appendChild(cell);
        }

        async function handleToggle(id, currentStatus, time, allData) {
            let nextStatus = currentStatus;
            if (user === 'me') {
                nextStatus = currentStatus === 0 ? 1 : (currentStatus === 1 ? 0 : currentStatus);
            } else if (user === 'oppa') {
                if (currentStatus === 1) nextStatus = 2;
                else if (currentStatus === 2) nextStatus = 1;
            }

            if (nextStatus !== currentStatus) {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ id, status: nextStatus }), mode: 'no-cors' });
                const idx = allData.daily.findIndex(d => d.id === id);
                if (idx > -1) allData.daily[idx].status = nextStatus;
                else allData.daily.push({ id, status: nextStatus });
                render(allData);
            }
        }

        function changeMonth(dir) {
            currentMonth += dir;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            const cached = localStorage.getItem('full_data_cache');
            if (cached) render(JSON.parse(cached));
            fetchData();
        }
        init();
    </script>
</body>
</html>
