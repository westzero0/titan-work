<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÏóÖÎ¨¥ Ïä§ÏºÄÏ§Ñ</title>
    <style>
        :root { --bg: #f4f7f6; --white: #ffffff; --green: #e2fbe5; --green-text: #155724; --blue: #007bff; --text: #333; --gray: #888; --skeleton: #eceef1; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { font-size: 1.1rem; margin: 0; font-weight: 600; }
        
        .role-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .role-me { background: var(--green); color: var(--green-text); border: 1px solid #a3cfbb; }
        .role-oppa { background: #cfe2ff; color: #084298; border: 1px solid #b6d4fe; }

        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; width: 100%; max-width: 500px; }
        .day-label { text-align: center; font-size: 0.7rem; color: var(--gray); font-weight: bold; padding-bottom: 5px; }
        
        .day { background: var(--white); border-radius: 12px; padding: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); text-align: center; display: flex; flex-direction: column; gap: 6px; min-height: 80px; }
        .date-num { font-size: 0.85rem; font-weight: bold; margin-bottom: 2px; }
        .today { border: 2px solid var(--blue); }

        .btn-group { display: flex; flex-direction: column; gap: 4px; }
        button { border: 1px solid #eee; border-radius: 8px; padding: 12px 0; font-size: 0.7rem; cursor: pointer; transition: background 0.2s; background: #fafafa; }
        
        button.status-1 { background-color: var(--green) !important; border-color: #a3cfbb; color: var(--green-text); font-weight: bold; }
        button.status-2 { background-color: var(--blue) !important; border-color: #0056b3; color: white; font-weight: bold; }

        /* Ïä§ÏºàÎ†àÌÜ§ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .skeleton-btn { background: linear-gradient(90deg, var(--skeleton) 25%, #f5f5f5 50%, var(--skeleton) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border: none; height: 35px; }
        .skeleton-text { background: var(--skeleton); height: 12px; width: 60%; margin: 0 auto 8px; border-radius: 4px; }

        .loading-bar { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: var(--blue); transition: width 0.3s; z-index: 1000; }
    </style>
</head>
<body>
    <div id="loading-bar" class="loading-bar"></div>
    <header>
        <h2 id="title">ÏóÖÎ¨¥ Ïä§ÏºÄÏ§Ñ</h2>
        <div id="badge" class="role-badge">Î°úÎî©Ï§ë</div>
    </header>
    
    <div class="calendar" id="calendar">
        <div class="day-label">Ïùº</div><div class="day-label">Ïõî</div><div class="day-label">Ìôî</div>
        <div class="day-label">Ïàò</div><div class="day-label">Î™©</div><div class="day-label">Í∏à</div><div class="day-label">ÌÜ†</div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzd8BYaicsFmw9CCVQXeWTbNbhAtZqmQ7oH4ZR4lBsloaRSWlqnztPTqNptWWBqcveMBQ/exec'; // Ïã§Ï†ú URLÎ°ú ÍµêÏ≤¥ ÌôïÏù∏!
        const urlParams = new URLSearchParams(window.location.search);
        const user = urlParams.get('user') || 'me';

        const badge = document.getElementById('badge');
        badge.innerText = user === 'me' ? "üôã‚Äç‚ôÄÔ∏è ÎÇ¥ ÏÑ§Ï†ï" : "üôã‚Äç‚ôÇÔ∏è Ïò§Îπ† ÌôïÏù∏";
        badge.className = `role-badge ${user === 'me' ? 'role-me' : 'role-oppa'}`;

        // 1. Ï¥àÍ∏∞ Ïã§Ìñâ: Ïä§ÏºàÎ†àÌÜ§ UI ÎòêÎäî Ï∫êÏãú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
        async function init() {
            const cachedData = localStorage.getItem('schedule_cache');
            
            if (cachedData) {
                // Ï∫êÏãúÍ∞Ä ÏûàÏúºÎ©¥ Ï¶âÏãú Î†åÎçîÎßÅ (Ï≤¥Í∞ê ÏÜçÎèÑ 0Ï¥à)
                renderCalendar(JSON.parse(cachedData));
            } else {
                // Ï∫êÏãú ÏóÜÏúºÎ©¥ Ïä§ÏºàÎ†àÌÜ§ ÌëúÏãú
                renderSkeleton();
            }

            // Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            try {
                const response = await fetch(API_URL + "?t=" + new Date().getTime());
                const newData = await response.json();
                
                // Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Ïû¨Î†åÎçîÎßÅ
                localStorage.setItem('schedule_cache', JSON.stringify(newData));
                document.getElementById('calendar').querySelectorAll('.day').forEach(el => el.remove());
                renderCalendar(newData);
            } catch (e) {
                console.error("ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®", e);
            }
        }

        function renderSkeleton() {
            const container = document.getElementById('calendar');
            for (let i = 0; i < 14; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.innerHTML = `<div class="skeleton-text"></div><div class="btn-group"><div class="skeleton-btn"></div><div class="skeleton-btn"></div></div>`;
                container.appendChild(dayDiv);
            }
        }

        function renderCalendar(data) {
            const container = document.getElementById('calendar');
            const today = new Date();
            const startPoint = new Date(today);
            startPoint.setDate(today.getDate() - today.getDay());

            for (let i = 0; i < 14; i++) {
                const d = new Date(startPoint);
                d.setDate(startPoint.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `day ${d.toDateString() === today.toDateString() ? 'today' : ''}`;
                dayDiv.innerHTML = `<div class="date-num">${d.getDate()}</div>`;
                
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';
                
                ['AM', 'PM'].forEach(time => {
                    const id = `${dateStr}-${time}`;
                    const item = data.find(item => item.id === id) || { status: 0 };
                    const btn = document.createElement('button');
                    btn.id = id;
                    updateButtonStyle(btn, item.status, time);
                    btn.onclick = () => handleToggle(id, time);
                    btnGroup.appendChild(btn);
                });
                dayDiv.appendChild(btnGroup);
                container.appendChild(dayDiv);
            }
        }

        function updateButtonStyle(btn, status, time) {
            btn.className = `status-${status}`;
            btn.dataset.status = status;
            const icon = time === 'AM' ? '‚òÄÔ∏è' : 'üåô';
            const label = time === 'AM' ? 'Ï£ºÍ∞Ñ' : 'ÏïºÍ∞Ñ';
            btn.innerText = status === 2 ? `${icon} ÌôïÏ†ï` : (status === 1 ? `${icon} Í∞ÄÎä•` : `${icon} ${label}`);
        }

        async function handleToggle(id, time) {
            const btn = document.getElementById(id);
            let currentStatus = parseInt(btn.dataset.status) || 0;
            let nextStatus = currentStatus;

            if (user === 'me') {
                if (currentStatus === 0) nextStatus = 1;
                else if (currentStatus === 1) nextStatus = 0;
                else return;
            } else if (user === 'oppa') {
                if (currentStatus === 1) nextStatus = 2;
                else if (currentStatus === 2) nextStatus = 1;
                else return;
            }

            if (nextStatus !== currentStatus) {
                updateButtonStyle(btn, nextStatus, time);
                
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÎèÑ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉàÎ°úÍ≥†Ïπ® Ïãú Ïú†ÏßÄÏö©)
                const currentCache = JSON.parse(localStorage.getItem('schedule_cache') || '[]');
                const index = currentCache.findIndex(item => item.id === id);
                if (index > -1) currentCache[index].status = nextStatus;
                else currentCache.push({ id, status: nextStatus });
                localStorage.setItem('schedule_cache', JSON.stringify(currentCache));

                document.getElementById('loading-bar').style.width = '100%';
                try {
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ id, status: nextStatus }), mode: 'no-cors' });
                } catch (e) {
                    alert("Ï†ÄÏû• Ïã§Ìå®!");
                    location.reload();
                } finally {
                    setTimeout(() => { document.getElementById('loading-bar').style.width = '0%'; }, 400);
                }
            }
        }
        init();
    </script>
</body>
</html>
