<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÏóÖÎ¨¥ Ïä§ÏºÄÏ§Ñ - ÏõîÍ∞Ñ</title>
    <style>
        :root { --bg: #f4f7f6; --white: #ffffff; --red: #ff4d4f; --blue: #007bff; --green: #e2fbe5; --text: #333; --border: #eee; --today-bg: #fff9db; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .nav-month { display: flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1rem; }
        .nav-btn { cursor: pointer; padding: 4px 10px; background: white; border: 1px solid var(--border); border-radius: 5px; font-size: 0.8rem; }
        
        .role-badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 12px; font-weight: bold; }
        .role-me { background: var(--green); color: #155724; border: 1px solid #a3cfbb; }
        .role-oppa { background: #cfe2ff; color: #084298; border: 1px solid #b6d4fe; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; max-width: 600px; background: var(--white); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .day-label { text-align: center; font-size: 0.65rem; color: #888; font-weight: 600; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .day-label:nth-child(7n+1) { color: var(--red); }
        
        .cell { position: relative; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); min-height: 90px; padding: 2px; display: flex; flex-direction: column; transition: background 0.2s; }
        .cell:nth-child(7n) { border-right: none; }
        
        /* Ïò§Îäò ÎÇ†Ïßú Í∞ïÏ°∞ Ïä§ÌÉÄÏùº */
        .cell.today { background-color: var(--today-bg) !important; border: 2px solid var(--blue) !important; z-index: 5; }
        .cell.today .date-num { color: var(--blue); font-size: 0.9rem; font-weight: 800; }

        .date-num { font-size: 0.8rem; font-weight: 600; margin-bottom: 2px; padding: 2px; z-index: 3; }
        .is-holiday .date-num { color: var(--red); }
        .holiday-label { font-size: 0.55rem; font-weight: normal; margin-left: 4px; opacity: 0.8; }
        .other-month { opacity: 0.2; pointer-events: none; }

        .btn-group { display: flex; flex-direction: column; gap: 2px; margin-top: auto; z-index: 3; }
        button.status { border: 1px solid var(--border); border-radius: 4px; padding: 5px 0; font-size: 0.6rem; cursor: pointer; background: rgba(255,255,255,0.8); line-height: 1; }
        button.status-1 { background: var(--green) !important; color: #155724; border-color: #a3cfbb; font-weight: bold; }
        button.status-2 { background: var(--blue) !important; color: white; border-color: #0056b3; font-weight: bold; }

        .cell.has-event { border-top: 1px solid rgba(0,0,0,0.05); }
        .event-title { font-size: 0.55rem; color: #444; padding: 2px 4px; z-index: 3; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .loading-bar { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: var(--blue); transition: width 0.3s; z-index: 1000; }
    </style>
</head>
<body>
    <div id="loading-bar" class="loading-bar"></div>
    <header>
        <div class="nav-month">
            <div class="nav-btn" onclick="changeMonth(-1)">‚óÄ</div>
            <span id="current-month">Î°úÎî©Ï§ë...</span>
            <div class="nav-btn" onclick="changeMonth(1)">‚ñ∂</div>
        </div>
        <div id="badge" class="role-badge">Î°úÎî©Ï§ë</div>
    </header>
    
    <div class="calendar-grid" id="calendar">
        <div class="day-label">Ïùº</div><div class="day-label">Ïõî</div><div class="day-label">Ìôî</div>
        <div class="day-label">Ïàò</div><div class="day-label">Î™©</div><div class="day-label">Í∏à</div><div class="day-label">ÌÜ†</div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby4b4qF3TgjlISH0cBlaEWlxJymbzxw4adNmWwRsT1EMQJq50tL9y43ZuHcsAdtD_ZF0Q/exec'; 
        const urlParams = new URLSearchParams(window.location.search);
        const user = urlParams.get('user') || 'me';
        let currentYear, currentMonth; 

        const holidayData = { "2026-01-01": "Ïã†Ï†ï", "2026-02-16": "ÏÑ§ÎÇ† Ïó∞Ìú¥", "2026-02-17": "ÏÑ§ÎÇ†", "2026-02-18": "ÏÑ§ÎÇ† Ïó∞Ìú¥", "2026-03-01": "ÏÇºÏùºÏ†à", "2026-03-02": "ÎåÄÏ≤¥Í≥µÌú¥Ïùº", "2026-05-05": "Ïñ¥Î¶∞Ïù¥ÎÇ†", "2026-05-24": "Î∂ÄÏ≤òÎãòÏò§Ïã†ÎÇ†", "2026-05-25": "ÎåÄÏ≤¥Í≥µÌú¥Ïùº", "2026-06-03": "ÏßÄÎ∞©ÏÑ†Í±∞", "2026-06-06": "ÌòÑÏ∂©Ïùº", "2026-08-15": "Í¥ëÎ≥µÏ†à", "2026-08-17": "ÎåÄÏ≤¥Í≥µÌú¥Ïùº", "2026-09-24": "Ï∂îÏÑù Ïó∞Ìú¥", "2026-09-25": "Ï∂îÏÑù", "2026-09-26": "Ï∂îÏÑù Ïó∞Ìú¥", "2026-10-03": "Í∞úÏ≤úÏ†à", "2026-10-05": "ÎåÄÏ≤¥Í≥µÌú¥Ïùº", "2026-10-09": "ÌïúÍ∏ÄÎÇ†", "2026-12-25": "ÏÑ±ÌÉÑÏ†à" };

        async function init() {
            const badge = document.getElementById('badge');
            badge.innerText = user === 'me' ? "üôã‚Äç‚ôÄÔ∏è ÎÇ¥ ÏÑ§Ï†ï" : "üôã‚Äç‚ôÇÔ∏è Ïò§Îπ† ÌôïÏù∏";
            badge.className = `role-badge ${user === 'me' ? 'role-me' : 'role-oppa'}`;
            const now = new Date();
            currentYear = now.getFullYear(); currentMonth = now.getMonth();
            await fetchData();
        }

        async function fetchData() {
            document.getElementById('loading-bar').style.width = '30%';
            try {
                const res = await fetch(API_URL + "?t=" + new Date().getTime());
                const allData = await res.json();
                localStorage.setItem('full_data_cache', JSON.stringify(allData));
                render(allData);
            } catch (e) {
                const cached = localStorage.getItem('full_data_cache');
                if (cached) render(JSON.parse(cached));
            } finally {
                document.getElementById('loading-bar').style.width = '0%';
            }
        }

        function render(allData) {
            document.getElementById('current-month').innerText = `${currentYear}.${(currentMonth + 1).toString().padStart(2, '0')}`;
            const container = document.getElementById('calendar');
            container.querySelectorAll('.cell').forEach(el => el.remove());
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            const prevLastDate = new Date(currentYear, currentMonth, 0).getDate();
            for (let i = firstDay - 1; i >= 0; i--) createCell(prevLastDate - i, true);
            for (let i = 1; i <= lastDate; i++) createCell(i, false, allData);
            const remaining = 42 - container.querySelectorAll('.cell').length;
            for (let i = 1; i <= remaining; i++) createCell(i, true);
        }

        function createCell(date, isOther, allData) {
            const cell = document.createElement('div');
            const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}`;
            const holidayName = holidayData[dateStr];
            
            // Ïò§Îäò ÎÇ†ÏßúÏù∏ÏßÄ ÌôïÏù∏
            const now = new Date();
            const isToday = !isOther && 
                            date === now.getDate() && 
                            currentMonth === now.getMonth() && 
                            currentYear === now.getFullYear();

            cell.className = `cell ${isOther ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
            
            if (holidayName) cell.classList.add('is-holiday');
            cell.innerHTML = `<div class="date-num">${date}${holidayName ? ` <span class="holiday-label">${holidayName}</span>` : ''}</div>`;
            
            if (!isOther && allData) {
                const eventOnThisDay = allData.events.find(ev => {
                    const s = new Date(ev.start); s.setHours(0,0,0,0);
                    const e = new Date(ev.end); e.setHours(0,0,0,0);
                    const curr = new Date(dateStr); curr.setHours(0,0,0,0);
                    return curr >= s && curr <= e;
                });

                if (eventOnThisDay) {
                    cell.classList.add('has-event');
                    cell.style.backgroundColor = eventOnThisDay.color + '33'; 
                    cell.innerHTML += `<div class="event-title">${eventOnThisDay.title}</div>`;
                } else {
                    const btnGroup = document.createElement('div');
                    btnGroup.className = 'btn-group';
                    ['AM', 'PM'].forEach(time => {
                        const id = `${dateStr}-${time}`;
                        const item = allData.daily.find(d => d.id === id) || { status: 0 };
                        const btn = document.createElement('button');
                        btn.className = `status status-${item.status}`;
                        btn.innerText = (time === 'AM' ? '‚òÄÔ∏è' : 'üåô') + (item.status === 2 ? ' ÌôïÏ†ï' : (item.status === 1 ? ' Í∞ÄÎä•' : ''));
                        btn.onclick = () => handleToggle(id, item.status, time, allData);
                        btnGroup.appendChild(btn);
                    });
                    cell.appendChild(btnGroup);
                }
            }
            document.getElementById('calendar').appendChild(cell);
        }

        async function handleToggle(id, currentStatus, time, allData) {
            let nextStatus = currentStatus;
            if (user === 'me') nextStatus = currentStatus === 0 ? 1 : (currentStatus === 1 ? 0 : currentStatus);
            else if (user === 'oppa' && currentStatus !== 0) nextStatus = currentStatus === 1 ? 2 : 1;
            
            if (nextStatus !== currentStatus) {
                document.getElementById('loading-bar').style.width = '100%';
                try {
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ id, status: nextStatus }), mode: 'no-cors' });
                    const idx = allData.daily.findIndex(d => d.id === id);
                    if (idx > -1) allData.daily[idx].status = nextStatus;
                    else allData.daily.push({ id, status: nextStatus });
                    localStorage.setItem('full_data_cache', JSON.stringify(allData));
                    render(allData);
                } finally {
                    setTimeout(() => { document.getElementById('loading-bar').style.width = '0%'; }, 400);
                }
            }
        }

        function changeMonth(dir) {
            currentMonth += dir;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            const cached = localStorage.getItem('full_data_cache');
            if (cached) render(JSON.parse(cached));
            fetchData();
        }
        init();
    </script>
</body>
</html>
