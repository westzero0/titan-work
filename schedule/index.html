<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì—…ë¬´ ìŠ¤ì¼€ì¤„</title>
    <style>
        /* ë””ìì¸ ìˆ˜ì • ë²„ì „ */
        :root { --bg: #f8f9fa; --white: #ffffff; --green: #e2fbe5; --green-text: #155724; --blue: #007bff; --text: #333; --gray: #888; --skeleton: #eceef1; --border: #eee; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        /* í—¤ë”: í•œ ì¤„ë¡œ ê¹”ë”í•˜ê²Œ ì •ë ¬ ë° í­ í™•ëŒ€ */
        header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { font-size: 1.1rem; margin: 0; font-weight: 600; }
        
        .role-badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 12px; font-weight: bold; white-space: nowrap; }
        .role-me { background: var(--green); color: var(--green-text); border: 1px solid #a3cfbb; }
        .role-oppa { background: #cfe2ff; color: #084298; border: 1px solid #b6d4fe; }

        /* ë‹¬ë ¥ ì»¨í…Œì´ë„ˆ: ìµœëŒ€ í­ì„ ëŠ˜ë¦¬ê³  ê°„ê²©ì„ ì¢í˜ */
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; width: 100%; max-width: 600px; }
        .day-label { text-align: center; font-size: 0.7rem; color: var(--gray); font-weight: 600; padding-bottom: 5px; }
        
        /* ë‚ ì§œ ì¹¸: ë‚´ë¶€ ì—¬ë°±ê³¼ ê°„ê²©ì„ ì¤„ì—¬ ì»´íŒ©íŠ¸í•˜ê²Œ */
        .day { background: var(--white); border-radius: 8px; padding: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center; display: flex; flex-direction: column; gap: 3px; }
        .date-num { font-size: 0.8rem; font-weight: 600; margin-bottom: 2px; }
        .today { border: 2px solid var(--blue); }

        .btn-group { display: flex; flex-direction: column; gap: 3px; }
        
        /* ë²„íŠ¼: ìœ„ì•„ë˜ ì—¬ë°±ì„ ëŒ€í­ ì¤„ì—¬ ë¹„ìœ¨ ê°œì„  */
        button { border: 1px solid var(--border); border-radius: 4px; padding: 6px 0; font-size: 0.65rem; cursor: pointer; transition: background 0.15s; background: #fcfcfc; color: #555; }
        
        button.status-1 { background-color: var(--green) !important; border-color: #a3cfbb; color: var(--green-text); font-weight: bold; }
        button.status-2 { background-color: var(--blue) !important; border-color: #0056b3; color: white; font-weight: bold; }

        /* ìŠ¤ì¼ˆë ˆí†¤ UIë„ ë¹„ìœ¨ì— ë§ì¶° ìˆ˜ì • */
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .skeleton-btn { background: linear-gradient(90deg, var(--skeleton) 25%, #f5f5f5 50%, var(--skeleton) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border: none; height: 22px; border-radius: 4px; }
        .skeleton-text { background: var(--skeleton); height: 10px; width: 50%; margin: 2px auto 5px; border-radius: 4px; }

        .loading-bar { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: var(--blue); transition: width 0.3s; z-index: 1000; }
    </style>
</head>
<body>
    <div id="loading-bar" class="loading-bar"></div>
    <header>
        <h2 id="title">ì—…ë¬´ ìŠ¤ì¼€ì¤„</h2>
        <div id="badge" class="role-badge">ë¡œë”©ì¤‘</div>
    </header>
    
    <div class="calendar" id="calendar">
        <div class="day-label">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div>
        <div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzd8BYaicsFmw9CCVQXeWTbNbhAtZqmQ7oH4ZR4lBsloaRSWlqnztPTqNptWWBqcveMBQ/exec'; // ì‹¤ì œ URL í™•ì¸ í•„ìˆ˜!
        const urlParams = new URLSearchParams(window.location.search);
        const user = urlParams.get('user') || 'me';

        const badge = document.getElementById('badge');
        badge.innerText = user === 'me' ? "ğŸ™‹â€â™€ï¸ ë‚´ ì„¤ì •" : "ğŸ™‹â€â™‚ï¸ ì˜¤ë¹  í™•ì¸";
        badge.className = `role-badge ${user === 'me' ? 'role-me' : 'role-oppa'}`;

        async function init() {
            const cachedData = localStorage.getItem('schedule_cache');
            if (cachedData) {
                renderCalendar(JSON.parse(cachedData));
            } else {
                renderSkeleton();
            }

            try {
                const response = await fetch(API_URL + "?t=" + new Date().getTime());
                const newData = await response.json();
                localStorage.setItem('schedule_cache', JSON.stringify(newData));
                document.getElementById('calendar').querySelectorAll('.day').forEach(el => el.remove());
                renderCalendar(newData);
            } catch (e) {
                console.error("ìµœì‹  ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", e);
                if (!cachedData) renderCalendar([]);
            }
        }

        function renderSkeleton() {
            const container = document.getElementById('calendar');
            for (let i = 0; i < 14; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.innerHTML = `<div class="skeleton-text"></div><div class="btn-group"><div class="skeleton-btn"></div><div class="skeleton-btn"></div></div>`;
                container.appendChild(dayDiv);
            }
        }

        function renderCalendar(data) {
            const container = document.getElementById('calendar');
            const today = new Date();
            const startPoint = new Date(today);
            startPoint.setDate(today.getDate() - today.getDay());

            for (let i = 0; i < 14; i++) {
                const d = new Date(startPoint);
                d.setDate(startPoint.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `day ${d.toDateString() === today.toDateString() ? 'today' : ''}`;
                dayDiv.innerHTML = `<div class="date-num">${d.getDate()}</div>`;
                
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';
                
                ['AM', 'PM'].forEach(time => {
                    const id = `${dateStr}-${time}`;
                    const item = data.find(item => item.id === id) || { status: 0 };
                    const btn = document.createElement('button');
                    btn.id = id;
                    updateButtonStyle(btn, item.status, time);
                    btn.onclick = () => handleToggle(id, time);
                    btnGroup.appendChild(btn);
                });
                dayDiv.appendChild(btnGroup);
                container.appendChild(dayDiv);
            }
        }

        function updateButtonStyle(btn, status, time) {
            btn.className = `status-${status}`;
            btn.dataset.status = status;
            const icon = time === 'AM' ? 'â˜€ï¸' : 'ğŸŒ™';
            const label = time === 'AM' ? 'ì£¼ê°„' : 'ì•¼ê°„';
            btn.innerText = status === 2 ? `${icon} í™•ì •` : (status === 1 ? `${icon} ê°€ëŠ¥` : `${icon} ${label}`);
        }

        async function handleToggle(id, time) {
            const btn = document.getElementById(id);
            let currentStatus = parseInt(btn.dataset.status) || 0;
            let nextStatus = currentStatus;

            if (user === 'me') {
                if (currentStatus === 0) nextStatus = 1;
                else if (currentStatus === 1) nextStatus = 0;
                else return;
            } else if (user === 'oppa') {
                if (currentStatus === 1) nextStatus = 2;
                else if (currentStatus === 2) nextStatus = 1;
                else return;
            }

            if (nextStatus !== currentStatus) {
                updateButtonStyle(btn, nextStatus, time);
                
                const currentCache = JSON.parse(localStorage.getItem('schedule_cache') || '[]');
                const index = currentCache.findIndex(item => item.id === id);
                if (index > -1) currentCache[index].status = nextStatus;
                else currentCache.push({ id, status: nextStatus });
                localStorage.setItem('schedule_cache', JSON.stringify(currentCache));

                document.getElementById('loading-bar').style.width = '100%';
                try {
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ id, status: nextStatus }), mode: 'no-cors' });
                } catch (e) {
                    // ì¡°ìš©íˆ ì‹¤íŒ¨ (ë‹¤ìŒ ë¡œë”© ë•Œ ë™ê¸°í™”ë¨)
                } finally {
                    setTimeout(() => { document.getElementById('loading-bar').style.width = '0%'; }, 400);
                }
            }
        }
        init();
    </script>
</body>
</html>
