<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ì¼€ì¤„ ê³µìœ </title>
    <style>
        :root { --bg: #f4f7f6; --white: #ffffff; --green: #e2fbe5; --green-text: #155724; --blue: #007bff; --text: #333; --gray: #888; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { font-size: 1.1rem; margin: 0; font-weight: 600; }
        
        /* ì—­í•  ë°°ì§€ ë””ìì¸ */
        .role-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .role-me { background: var(--green); color: var(--green-text); border: 1px solid #a3cfbb; }
        .role-oppa { background: #cfe2ff; color: #084298; border: 1px solid #b6d4fe; }

        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; width: 100%; max-width: 500px; }
        .day-label { text-align: center; font-size: 0.7rem; color: var(--gray); font-weight: bold; padding-bottom: 5px; }
        
        .day { background: var(--white); border-radius: 12px; padding: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); text-align: center; display: flex; flex-direction: column; gap: 6px; }
        .date-num { font-size: 0.85rem; font-weight: bold; margin-bottom: 2px; }
        .today { border: 2px solid var(--blue); }

        .btn-group { display: flex; flex-direction: column; gap: 4px; }
        button { border: 1px solid #eee; border-radius: 8px; padding: 12px 0; font-size: 0.7rem; cursor: pointer; transition: all 0.15s; background: #fafafa; -webkit-tap-highlight-color: transparent; }
        
        /* ë²„íŠ¼ ìƒíƒœ ìŠ¤íƒ€ì¼ */
        button.status-1 { background-color: var(--green) !important; border-color: #a3cfbb; color: var(--green-text); font-weight: bold; }
        button.status-2 { background-color: var(--blue) !important; border-color: #0056b3; color: white; font-weight: bold; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .loading-bar { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: var(--blue); transition: width 0.3s; z-index: 1000; }
    </style>
</head>
<body>
    <div id="loading-bar" class="loading-bar"></div>
    <header>
        <h2 id="title">ìŠ¤ì¼€ì¤„ ë¡œë”©...</h2>
        <div id="badge" class="role-badge">ë¡œë”©ì¤‘</div>
    </header>
    
    <div class="calendar" id="calendar">
        <div class="day-label">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div>
        <div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
    </div>

    <script>
        const API_URL = 'ì—¬ê¸°ì—_ë³¸ì¸ì˜_ì›¹_ì•±_URL_ì…ë ¥'; 
        const urlParams = new URLSearchParams(window.location.search);
        const user = urlParams.get('user') || 'me';

        // ìƒë‹¨ UI ì„¤ì •
        const badge = document.getElementById('badge');
        document.getElementById('title').innerText = "ğŸ“… ì—…ë¬´ ìŠ¤ì¼€ì¤„";
        badge.innerText = user === 'me' ? "ğŸ™‹â€â™€ï¸ ë‚´ ì„¤ì •" : "ğŸ™‹â€â™‚ï¸ ì˜¤ë¹  í™•ì¸";
        badge.className = `role-badge ${user === 'me' ? 'role-me' : 'role-oppa'}`;

        async function init() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                renderCalendar(data);
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", e);
                renderCalendar([]);
            }
        }

        function renderCalendar(data) {
            const container = document.getElementById('calendar');
            const today = new Date();
            const startPoint = new Date(today);
            startPoint.setDate(today.getDate() - today.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼ë¶€í„° ì‹œì‘

            for (let i = 0; i < 14; i++) { // 2ì£¼ì¹˜ í‘œì‹œ
                const d = new Date(startPoint);
                d.setDate(startPoint.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `day ${d.toDateString() === today.toDateString() ? 'today' : ''}`;
                dayDiv.innerHTML = `<div class="date-num">${d.getDate()}</div>`;
                
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';
                
                ['AM', 'PM'].forEach(time => {
                    const id = `${dateStr}-${time}`;
                    const item = data.find(item => item.id === id) || { status: 0 };
                    const btn = document.createElement('button');
                    btn.id = id;
                    btn.dataset.status = item.status;
                    updateButtonStyle(btn, item.status, time);
                    
                    btn.onclick = () => handleToggle(id, time);
                    btnGroup.appendChild(btn);
                });
                dayDiv.appendChild(btnGroup);
                container.appendChild(dayDiv);
            }
        }

        function updateButtonStyle(btn, status, time) {
            btn.className = `status-${status}`;
            btn.dataset.status = status;
            const icon = time === 'AM' ? 'â˜€ï¸' : 'ğŸŒ™';
            const label = time === 'AM' ? 'ì£¼ê°„' : 'ì•¼ê°„';
            btn.innerText = status === 2 ? `${icon} í™•ì •` : (status === 1 ? `${icon} ê°€ëŠ¥` : `${icon} ${label}`);
        }

        async function handleToggle(id, time) {
            const btn = document.getElementById(id);
            let currentStatus = parseInt(btn.dataset.status) || 0;
            let nextStatus = currentStatus;

            // í•µì‹¬ ë¡œì§: ê¶Œí•œë³„ ì—„ê²© ë¶„ë¦¬
            if (user === 'me') {
                if (currentStatus === 0) nextStatus = 1;      // ë¹ˆì¹¸ -> ê°€ëŠ¥
                else if (currentStatus === 1) nextStatus = 0; // ê°€ëŠ¥ -> ë¹ˆì¹¸
                else return; // í™•ì •ëœ ê²ƒì€ ìˆ˜ì • ë¶ˆê°€
            } 
            else if (user === 'oppa') {
                if (currentStatus === 1) nextStatus = 2;      // ê°€ëŠ¥ -> í™•ì •
                else if (currentStatus === 2) nextStatus = 1; // í™•ì • -> ê°€ëŠ¥(ì·¨ì†Œ)
                else return; // ë¹ˆì¹¸ì€ í´ë¦­ ë¬´ì‹œ
            }

            if (nextStatus !== currentStatus) {
                // 1. í™”ë©´ ì¦‰ì‹œ ë°˜ì˜ (Optimistic UI)
                updateButtonStyle(btn, nextStatus, time);
                document.getElementById('loading-bar').style.width = '100%';

                try {
                    // 2. ë°±ê·¸ë¼ìš´ë“œ ì„œë²„ ì €ì¥
                    await fetch(API_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ id, status: nextStatus }),
                        mode: 'no-cors' // ì†ë„ í–¥ìƒì„ ìœ„í•´ ì‘ë‹µ ëŒ€ê¸° ìƒëµ
                    });
                } catch (e) {
                    alert("ì €ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    location.reload();
                } finally {
                    setTimeout(() => { document.getElementById('loading-bar').style.width = '0%'; }, 500);
                }
            }
        }
        init();
    </script>
</body>
</html>
