<!DOCTYPE html>
<html lang="ko">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>íƒ€ì´íƒ„ ê´€ë¦¬ì íŒ¨ë„</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <style>
    :root { --primary-color: #2563eb; --bg-color: #f8f9fa; }
    body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-color); margin: 0; padding: 0; overflow: hidden; }

      button:active {
    opacity: 0.8;
    transform: scale(0.98);
}
      
   /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ê³µí†µ ìš”ì†Œ --- */
.header { background: #fff; padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid #ddd; position: fixed; top:0; width: 100%; z-index: 100; }

.swiper { 
    width: 100%; 
    height: calc(100vh - 130px); /* ğŸŸ¢ ë†’ì´ ê³„ì‚°ê°’ë„ ì‚´ì§ ì¡°ì • (ë‚´ë¹„ë°” ê³µê°„ í™•ë³´) */
    margin-top: 65px; /* ğŸŸ¢ ê¸°ì¡´ 50pxì—ì„œ 65pxë¡œ ì¦ê°€ */
}

.card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
h3 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; }

label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #444; }
input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
button { width: 100%; padding: 15px; margin-top: 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; }

/* 1. í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜: ê°•ë ¥ ê³ ì • ë° ê·¸ë˜í”½ ê°€ì† ì ìš© */
.bottom-nav {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 65px;
    background: #fff;
    display: flex;
    border-top: 1px solid #ddd;
    z-index: 2147483647 !important; /* ë¬´ì¡°ê±´ ë§¨ ìœ„ë¡œ */
    transform: translateZ(0);       /* ìŠ¤ì™€ì´í”„ ì‹œ ê¹œë¹¡ì„ ë°©ì§€ */
    -webkit-transform: translateZ(0);
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    touch-action: none;
}

/* 2. ìŠ¬ë¼ì´ë“œ ì—¬ë°±: ë‚´ë¹„ê²Œì´ì…˜ì— ê°€ë ¤ì§€ì§€ ì•Šê²Œ í•˜ë‹¨ ì—¬ë°± í™•ë³´ */
.swiper-slide { 
    overflow-y: auto; 
    padding: 15px 12px; 
    box-sizing: border-box; 
    padding-bottom: 90px !important; /* 65px(ë‚´ë¹„) + ì—¬ìœ  */
    background-color: #f1f5f9; 
}
    
    
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 11px; cursor: pointer; }
.nav-item.active { color: var(--primary-color); }
.nav-item i { font-size: 20px; margin-bottom: 4px; }

/* --- [í•µì‹¬] í˜„ì¥ í˜„í™© ê´€ë¦¬ (ì¤‘ì²© ìŠ¤ì™€ì´í¼ ìŠ¤íƒ€ì¼) --- */
#client-management-list { width: 100%; padding: 0; }

.client-management-swiper { 
    width: 100%; 
    padding-top: 5px !important; /* â¬…ï¸ ì¹´ë“œ ë¨¸ë¦¬ê°€ ë„ˆë¬´ ë¶™ëŠ”ê²Œ ì‹«ìœ¼ë©´ 5px ì •ë„ë§Œ */
    padding-bottom: 45px !important; 
}

.client-slide { width: 94% !important; display: flex; align-items: stretch; }

.client-card {
    width: 100%;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    border: none;
    display: flex;
    flex-direction: column;
    min-height: 480px; /* ì¹´ë“œê°€ ì‘ì•„ ë³´ì´ì§€ ì•Šê²Œ ìµœì†Œ ë†’ì´ ê³ ì • */
}

.client-header {
    background: #ffffff;
    padding: 20px;
    font-size: 1.15rem;
    font-weight: 800;
    color: #1e293b;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    align-items: center;
    gap: 12px;
}

.site-list { flex: 1; overflow-y: auto; padding: 5px 0; }

.site-row {
    display: flex !important;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid #f8fafc;
}

.site-content { flex: 1; text-align: left; min-width: 0; }
.site-name { font-size: 1.05rem; font-weight: 700; color: #334155; margin-bottom: 4px; }
.site-addr { font-size: 0.85rem; color: #64748b; text-decoration: underline; cursor: pointer; }

/* ì§„í–‰/ì™„ë£Œ ìƒíƒœ ë²„íŠ¼ */
.status-btn {
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: bold;
    border: none;
    min-width: 80px;
    cursor: pointer;
}
.status-btn.ing { background: #eefdf3; color: #16a34a; }
.status-btn.completed { background: #f1f5f9; color: #94a3b8; }

/* ì™„ë£Œëœ í˜„ì¥ ì²˜ë¦¬ */
.status-done { opacity: 0.7; background-color: #fcfcfc; }
.status-done .site-name { text-decoration: line-through; color: #94a3b8; }

.swiper-pagination-bullet-active { background: #2563eb !important; }

/* --- ì§ì› ê´€ë¦¬ ì¹´ë“œ ìŠ¤íƒ€ì¼ --- */
#worker-list-admin { display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
.worker-card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-top: 4px solid #ddd; position: relative; display: block; }
.worker-card .name { font-size: 1.1rem; font-weight: bold; color: #333; }
.status-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 20px; color: #fff; font-weight: bold; }
.status-on { background: #2563eb; }
.status-off { background: #ef4444; }
.info { margin-top: 10px; font-size: 0.9rem; line-height: 1.6; color: #555; }
.copyable { color: #2563eb; text-decoration: underline; cursor: pointer; word-break: break-all; }
.card-btns { margin-top: 15px; display: flex; gap: 8px; }


    /* ì¹©ì´ ê°€ë¡œë¡œ ë‚˜ì—´ë˜ë„ë¡ ì„¤ì • */
#client-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
    padding: 0 5px;
}

.chip {
    padding: 8px 14px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #555;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.2s;
}

/* ì¹© í´ë¦­ ì‹œ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
.chip.active {
    background: #2563eb;
    color: #fff;
    border-color: #2563eb;
}


    /* ì¼ì •ë“±ë¡ íŒì—… ëª¨ë‹¬ ë°°ê²½ */
.modal {
    display: none; 
    position: fixed; z-index: 1000; left: 0; top: 0;
    width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
}

/* íŒì—…ì°½ ë³¸ì²´ */
.modal-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.close {
    color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
}

/* ê°„ë‹¨í•œ ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
#calendar-container {
  padding: 0;                   /* ğŸŸ¢ ì—¬ë°± 0ìœ¼ë¡œ ì„¤ì • (ê½‰ ì°¨ê²Œ) */
    background: #fff;
    min-height: 300px;
    text-align: center;
}

    /* --- ë‹¬ë ¥ í…Œë‘ë¦¬ ì œê±° ë° ê³µê°„ í™•ì¥ --- */

/* 1. ë‹¬ë ¥ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” 'ê²‰ í…Œë‘ë¦¬' ì œê±° (í•µì‹¬!) */
.fc-theme-standard .fc-scrollgrid {
    border: none !important;
}

/* 2. ìš”ì¼(ì¼,ì›”,í™”...) ë°•ìŠ¤ í…Œë‘ë¦¬ ì œê±° */
.fc-theme-standard th {
    border: none !important;
    border-bottom: 1px solid #f0f0f0 !important; /* ìš”ì¼ ì•„ë˜ì—ë§Œ ì•„ì£¼ ì—°í•œ ì¤„ ë‚¨ê¹€ */
}

/* 3. ë‚ ì§œ ì¹¸(ì…€) í…Œë‘ë¦¬ ì•„ì£¼ ì—°í•˜ê²Œ ë³€ê²½ (ì™„ì „ ì—†ì• ë©´ êµ¬ë¶„ì´ ì•ˆ ê°ˆ ìˆ˜ ìˆìŒ) */
.fc-theme-standard td {
    border: 1px solid #f8fafc !important; /* ë°°ê²½ìƒ‰ê³¼ ê±°ì˜ ë¹„ìŠ·í•œ ì—°íšŒìƒ‰ */
    border-top: none !important; /* ìœ—ì¤„ ì œê±°í•´ì„œ ì‹œì›í•˜ê²Œ */
}

/* 4. ë‹¬ë ¥ ë§¨ ì•„ë˜ìª½ ë¶ˆí•„ìš”í•œ ì—¬ë°± ì œê±° */
.fc-view-harness {
    background-color: #fff; /* ë°°ê²½ í°ìƒ‰ */
}

/* 5. (ì„ íƒì‚¬í•­) ì˜¤ëŠ˜ ë‚ ì§œ ë°°ê²½ìƒ‰ì„ ì—°í•œ íŒŒë‘ìœ¼ë¡œ ì¹ í•´ì„œ í…Œë‘ë¦¬ ì—†ì´ë„ êµ¬ë¶„ë˜ê²Œ í•¨ */
.fc-day-today {
    background-color: #eff6ff !important; 
}
    
    
  </style>
  
</head>


    
<body>
  <div class="header">âš¡ íƒ€ì´íƒ„ í†µí•© ê´€ë¦¬ì</div>


    <div class="swiper">
  <div class="swiper-wrapper">
    <div class="swiper-slide">

        
    <div class="card">
    <h3>ğŸ‘¤ ì‹ ê·œ ì¸ì› ë“±ë¡</h3>
    <input type="text" id="new-name" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">
    <select id="new-role">
        <option value="ê¸°ê³µ">ê¸°ê³µ</option>
        <option value="ì¡°ê³µ">ì¡°ê³µ</option>
    </select>
    <input type="number" id="new-rate" placeholder="ì¼ë‹¹ (ìˆ«ìë§Œ)">
    <input type="text" id="new-phone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ (ì˜ˆ: 010-1234-5678)">
    <input type="text" id="new-address" placeholder="ì§‘ì£¼ì†Œ">
    <input type="password" id="new-pw" placeholder="ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)" maxlength="4">
    <button class="btn-blue" onclick="addWorker()">ë“±ë¡í•˜ê¸°</button>
</div>
   

    <div class="card">
        <h3>ğŸ‘¥ ì§ì› ê´€ë¦¬</h3>
        <div id="worker-list-admin">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
     </div>

      <div class="swiper-slide">
     <div class="card">
    <h3>ğŸ¢ ê±°ë˜ì²˜ ë° í˜„ì¥ ë“±ë¡</h3>
    
    <div class="copy-hint" style="margin-bottom:8px;">ê¸°ì¡´ ê±°ë˜ì²˜ ì„ íƒ (ë˜ëŠ” ì§ì ‘ ì…ë ¥)</div>
    <div id="client-chips" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px;">
        </div>
    
    <div class="input-group">
        <label>ê±°ë˜ì²˜ëª…</label>
        <input type="text" id="c_client" placeholder="ì¹©ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”">
    </div>
    
    <div class="input-group">
        <label>í˜„ì¥ëª…</label>
        <input type="text" id="c_site" placeholder="í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>
    
    <div class="input-group">
        <label>í˜„ì¥ ì£¼ì†Œ</label>
        <input type="text" id="c_addr" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (Dì—´ ì €ì¥)">
    </div>
    
    <button class="btn-blue" onclick="saveClient()" style="width:100%">í˜„ì¥ ë“±ë¡í•˜ê¸°</button>
</div>

<div class="card" style="margin-top:20px;">
    <h3>ğŸ“‹ í˜„ì¥ í˜„í™© ê´€ë¦¬</h3>
    <div id="client-management-list">
        </div>
</div>
    </div>

    <div class="swiper-slide">
      <div class="card">
        <h3>ğŸ“¦ ìì¬ ë§ˆìŠ¤í„° ë“±ë¡</h3>
        <label>ëŒ€ë¶„ë¥˜</label><input type="text" id="m_cat">
        <label>í’ˆëª©</label><input type="text" id="m_name">
        <label>ê·œê²©</label><input type="text" id="m_spec">
        <label>ë‹¨ìœ„</label><input type="text" id="m_unit">
        <label>ë‹¨ê°€</label><input type="number" id="m_price">
        <button onclick="saveMaterial()">ìì¬ í’ˆëª© ë“±ë¡</button>
      </div>
    </div>

   <div class="swiper-slide">
        <div id="schedule-admin" class="card swiper-no-swiping">
            <h3>ğŸ“… ì‘ì—… ì¼ì • <span style="font-size:0.8rem; color:#666; font-weight:normal;">(ë‚ ì§œ í´ë¦­: ë“±ë¡ / ë°” í´ë¦­: ìˆ˜ì •)</span></h3>
            
            <div id="calendar-container"></div>
            
            <h4 style="margin-top:25px; border-bottom:2px solid #f1f5f9; padding-bottom:10px; color:#1e293b;">ğŸ“‹ ë‹¤ê°€ì˜¤ëŠ” ìƒì„¸ ì¼ì •</h4>
            <div id="schedule-list-container" style="padding-top:10px;">
                <div style="text-align:center; padding:30px; color:#999;">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

   <div id="schedule-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="margin-bottom:15px; display:flex; justify-content:space-between;">
            <h3 id="modal-date-title" style="margin:0; color:#2563eb;">ì¼ì • ë“±ë¡</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        
        <input type="hidden" id="sched-row-id">
        <input type="hidden" id="sched-date">
        <input type="hidden" id="sched-end-date">
        <input type="hidden" id="sched-client">
        <input type="hidden" id="sched-site">
        <input type="hidden" id="sched-shift" value="ì£¼ê°„">

        <div class="input-group">
            <label>ğŸ¢ ê±°ë˜ì²˜ ì„ íƒ (ì§„í–‰ì¤‘ì¸ í˜„ì¥ë§Œ í‘œì‹œ)</label>
            <div id="sched-client-chips-area" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;"></div>

            <label>ğŸ—ï¸ í˜„ì¥ ì„ íƒ</label>
            <div id="sched-site-chips-area" style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px;">
                <span style="color:#aaa; font-size:0.8rem;">ê±°ë˜ì²˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</span>
            </div>

            <label>â° ê·¼ë¬´ í˜•íƒœ</label>
            <div id="shift-toggle-btn" onclick="toggleShift()" style="background:#3b82f6; color:white; padding:10px; text-align:center; border-radius:8px; font-weight:bold; cursor:pointer;">
                ğŸŒ ì£¼ê°„
            </div>

            <label style="margin-top:15px;">ğŸ‘· íˆ¬ì… ì¸ì› <span id="worker-count-display">(0ëª…)</span></label>
            <input type="hidden" id="sched-workers-text">
            
            <div id="selected-workers-box" style="min-height:40px; border:1px solid #ddd; border-radius:8px; padding:8px; display:flex; flex-wrap:wrap; gap:5px; margin-bottom:5px; background:#fff;">
                <span style="color:#aaa; font-size:0.8rem; padding:5px;">ì•„ë˜ ëª©ë¡ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”.</span>
            </div>
            <input type="text" id="worker-search-input" placeholder="ğŸ” ì´ë¦„ ê²€ìƒ‰" onkeyup="filterWorkerChips()" style="margin-bottom:5px;">
            <div id="worker-chips-area" style="max-height:150px; overflow-y:auto; background:#f8f9fa; padding:10px; border-radius:8px; display:flex; flex-wrap:wrap; gap:5px;"></div>

            <label style="margin-top:15px;">ğŸš› ì°¨ëŸ‰ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
            <input type="text" id="sched-car" placeholder="ì°¨ëŸ‰ ì§ì ‘ ì…ë ¥">
            <div id="car-chips-area" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                </div>

            <label>ğŸ“ ì‘ì—…ë‚´ìš© (í„°ì¹˜í•´ì„œ ì¶”ê°€)</label>
            <div id="work-content-chips" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:5px;"></div>
            <textarea id="sched-content" rows="2" placeholder="ì‘ì—… ë‚´ìš©"></textarea>
            
            <label>íŠ¹ì´ì‚¬í•­</label>
            <textarea id="sched-note" rows="1" placeholder="íŠ¹ì´ì‚¬í•­"></textarea>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="button" id="btn-save" onclick="saveSchedule('add')" style="flex:2;">ì €ì¥</button>
                <button type="button" id="btn-update" onclick="saveSchedule('update')" style="flex:2; display:none;">ìˆ˜ì •</button>
                <button type="button" id="btn-delete" onclick="deleteSchedule()" style="flex:1; display:none; background:#fee2e2; color:#ef4444;">ì‚­ì œ</button>
            </div>
        </div>
    </div>
  </div>
     
      
    </div>

       </div>
</div>

<div class="bottom-nav" id="main-nav">
    <div class="nav-item active" onclick="jumpTo(0)">ğŸ‘¥ <span>ì¸ì›</span></div>
    <div class="nav-item" onclick="jumpTo(1)">ğŸ¢ <span>ê±°ë˜ì²˜</span></div>
    <div class="nav-item" onclick="jumpTo(2)">ğŸ“¦ <span>ìì¬</span></div>
    <div class="nav-item" onclick="jumpTo(3)">ğŸ“… <span>ì¼ì •</span></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    
      
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx0r8IPhDytW9knWTEbsFRVK4HmFj5CynrD9TlXzIbOe_aSDotaATcnSzouC845NIBx/exec"; // ğŸ‘ˆ ê¼­ ë³¸ì¸ ì£¼ì†Œë¡œ ìˆ˜ì •í•˜ì„¸ìš”!
let calendar = null;
    let swiper = null;
    let globalScheduleData = [];
    let globalClientData = [];
    let globalWorkerData = [];
    
    // ğŸŸ¢ ì„ íƒ ë°ì´í„° ê´€ë¦¬ìš© Set ë³€ìˆ˜ (ë§¤ìš° ì¤‘ìš”)
    let selectedWorkerSet = new Set();
    let selectedWorkSet = new Set();

    // [1] ì´ˆê¸°í™” ì‹¤í–‰
    window.addEventListener('DOMContentLoaded', async () => {
        initSwiper();
        try {
            console.log("ë°ì´í„° ë¡œë“œ ì¤‘...");
            await Promise.all([
                loadAdminData(),
                loadClientManagement(),
                loadScheduleData()
            ]);
            console.log("ë°ì´í„° ë¡œë“œ ì™„ë£Œ");
            initCalendar();
            renderScheduleList();
        } catch (e) {
            console.error("ë¡œë”© ì‹¤íŒ¨:", e);
            initCalendar();
        }
    });

    // [2] ìŠ¤ì™€ì´í¼ ì„¤ì •
    function initSwiper() {
        const el = document.querySelector('.swiper');
        if (!el) return;
        swiper = new Swiper('.swiper', {
            speed: 400, loop: false, allowTouchMove: true,
            noSwiping: true, noSwipingClass: 'swiper-no-swiping',
            on: { slideChange: function () { updateNav(this.activeIndex); } }
        });
    }
    function jumpTo(index) { if (swiper) swiper.slideTo(index); }
    function updateNav(index) {
        document.querySelectorAll('.nav-item').forEach((item, i) => {
            if (i === index) item.classList.add('active'); else item.classList.remove('active');
        });
    }

    // [3] ë‹¬ë ¥ ì„¤ì •
    function initCalendar() {
        const el = document.getElementById('calendar-container');
        if (!el) return;

        const events = globalScheduleData.map(item => {
            let title = item.site;
            if(item.workers) {
                const count = item.workers.split(',').length;
                title += ` (${count}ëª…)`;
            }
            return {
                id: item.rowId, title: title, start: item.date,
                backgroundColor: item.shift === 'ì•¼ê°„' ? '#475569' : '#3b82f6',
                borderColor: 'transparent', extendedProps: item
            };
        });

        if (calendar) calendar.destroy();
        calendar = new FullCalendar.Calendar(el, {
            initialView: 'dayGridMonth', locale: 'ko', height: 'auto',
            longPressDelay: 0, eventLongPressDelay: 0, selectLongPressDelay: 0, // ì¦‰ì‹œ ë°˜ì‘
            headerToolbar: { left: 'prev', center: 'title', right: 'next' },
            dayCellContent: (info) => ({ html: info.dayNumberText.replace('ì¼', '') }),
            selectable: true, selectMirror: true,
            
            select: (info) => openModal('add', info.startStr, null, info.endStr),
            eventClick: (info) => openModal('edit', null, info.event.extendedProps),
            events: events
        });
        calendar.render();
    }

    // [4] ì¼ì • ë¦¬ìŠ¤íŠ¸ (ì˜¤ëŠ˜ ì´í›„)
    function renderScheduleList() {
        const box = document.getElementById('schedule-list-container');
        const today = new Date().toISOString().split('T')[0];
        const list = (Array.isArray(globalScheduleData) ? globalScheduleData : [])
            .filter(i => i.date >= today)
            .sort((a, b) => new Date(a.date) - new Date(b.date));

        if (list.length === 0) { box.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">ğŸ“… ì˜¤ëŠ˜ ì´í›„ ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

        box.innerHTML = list.map(item => `
            <div class="card" style="margin-bottom:10px; padding:15px; border-left:5px solid ${item.shift==='ì•¼ê°„'?'#475569':'#2563eb'}; cursor:pointer;" 
                 onclick='openModal("edit", null, ${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                <div style="font-weight:bold; font-size:1.1rem; color:#333;">${item.date} <span style="font-size:0.8rem; background:#eee; padding:2px 5px; border-radius:4px;">${item.shift}</span> ${item.date===today?'<span style="background:#ef4444; color:#fff; font-size:0.7rem; padding:2px 6px; border-radius:4px;">Today</span>':''}</div>
                <div style="font-size:1.05rem; margin-top:8px; font-weight:bold; color:#1e293b;">${item.site} <span style="color:#64748b; font-weight:normal; font-size:0.9rem;">(${item.client})</span></div>
                <div style="font-size:0.9rem; color:#666; margin-top:6px;">ğŸ‘· ${item.workers || 'ë¯¸ì •'} | ğŸš› ${item.car || '-'}</div>
            </div>
        `).join('');
    }

    // [5] ëª¨ë‹¬ ì—´ê¸°
    function openModal(mode, dateStr, data, endStr = null) {
        const modal = document.getElementById('schedule-modal');
        modal.style.display = 'block';

        if (mode === 'add') {
            document.getElementById('sched-date').value = dateStr;
            document.getElementById('sched-end-date').value = endStr || "";
            let title = dateStr + " ì¼ì • ë“±ë¡";
            if (endStr) {
                const diff = (new Date(endStr) - new Date(dateStr)) / (1000 * 60 * 60 * 24);
                if (diff > 1) title = `${dateStr} ~ (${Math.ceil(diff)}ì¼ê°„)`;
            }
            document.getElementById('modal-date-title').innerText = title;
            resetForm();
            
            // ğŸŸ¢ ëª¨ë“  ì¹© ë Œë”ëŸ¬ í˜¸ì¶œ (ë¹ˆ ê°’ìœ¼ë¡œ)
            renderChips('', '');
            renderWorkerChips("");
            renderVehicleChips("");
            initWorkPresets("");
            currentShiftIndex = 0; updateShiftBtn();

            document.getElementById('btn-save').style.display = 'block';
            document.getElementById('btn-update').style.display = 'none';
            document.getElementById('btn-delete').style.display = 'none';
        } else {
            document.getElementById('modal-date-title').innerText = "ì¼ì • ìˆ˜ì •";
            document.getElementById('sched-row-id').value = data.rowId;
            document.getElementById('sched-date').value = data.date;
            document.getElementById('sched-end-date').value = "";
            document.getElementById('sched-note').value = data.note || "";

            const shiftIdx = SHIFT_TYPES.indexOf(data.shift);
            currentShiftIndex = shiftIdx >= 0 ? shiftIdx : 0;
            updateShiftBtn();

            // ğŸŸ¢ ë°ì´í„° ì±„ì›Œì„œ ì¹© ë Œë”ë§
            renderChips(data.client, data.site);
            renderWorkerChips(data.workers || "");
            renderVehicleChips(data.car || "");
            initWorkPresets(data.content || ""); // ì‘ì—…ë‚´ìš©ì€ content í•„ë“œ ì‚¬ìš©

            document.getElementById('btn-save').style.display = 'none';
            document.getElementById('btn-update').style.display = 'block';
            document.getElementById('btn-delete').style.display = 'block';
        }
    }

    function closeModal() { document.getElementById('schedule-modal').style.display = "none"; }
    function resetForm() {
        ['sched-client', 'sched-site', 'sched-workers-text', 'sched-car', 'sched-content', 'sched-note', 'worker-search-input', 'new-work-input'].forEach(id => {
            const el = document.getElementById(id); if(el) el.value = "";
        });
        selectedWorkerSet.clear();
        selectedWorkSet.clear();
    }

    // [6] ì¹© ë Œë”ë§ ë¡œì§ë“¤
    // 6-1. ê±°ë˜ì²˜/í˜„ì¥ (ì§„í–‰ì¤‘ë§Œ)
    function renderChips(sClient, sSite) {
        const cBox = document.getElementById('sched-client-chips-area');
        const sBox = document.getElementById('sched-site-chips-area');
        const activeData = globalClientData.filter(item => item.status !== 'ì™„ë£Œ' || (item.client === sClient && item.site === sSite));
        const uniques = [...new Set(activeData.map(i => i.client))];

        if (cBox) cBox.innerHTML = uniques.map(c => `<div class="chip ${c === sClient ? 'active' : ''}" onclick="clkClient(this, '${c}')">${c}</div>`).join('');
        document.getElementById('sched-client').value = sClient || "";

        if (sClient) {
            const sites = activeData.filter(i => i.client === sClient);
            if (sBox) sBox.innerHTML = sites.map(s => `<div class="chip ${s.site === sSite ? 'active' : ''}" onclick="clkSite(this, '${s.site}')">${s.site}</div>`).join('');
            document.getElementById('sched-site').value = sSite || "";
        } else {
            if (sBox) sBox.innerHTML = '<span style="color:#aaa; font-size:0.8rem;">ê±°ë˜ì²˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</span>';
        }
    }
    function clkClient(el, name) { document.getElementById('sched-client').value = name; renderChips(name, ''); }
    function clkSite(el, name) { 
        document.getElementById('sched-site').value = name; 
        Array.from(el.parentNode.children).forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    // 6-2. ì¸ì› ì„ íƒ (ê²€ìƒ‰ + ì¬ì§ìë§Œ)
    function renderWorkerChips(namesStr) {
        const container = document.getElementById('worker-chips-area');
        const sInput = document.getElementById('worker-search-input');
        if(sInput) sInput.value = "";
        
        selectedWorkerSet.clear();
        if (namesStr) namesStr.split(',').map(s=>s.trim()).forEach(n => { if(n) selectedWorkerSet.add(n); });

        if(container) {
            container.innerHTML = globalWorkerData.filter(w => w.status === 'ì¬ì§').map(w => {
                const isSelected = selectedWorkerSet.has(w.name);
                return `<div class="chip worker-candidate" data-name="${w.name}" onclick="addWorkerToSelection('${w.name}')" style="background:#fff; border:1px solid #ddd; display:${isSelected?'none':'inline-flex'}">${w.name}</div>`;
            }).join('');
        }
        renderSelectedBox();
    }
    function filterWorkerChips() {
        const input = document.getElementById('worker-search-input').value.toLowerCase();
        document.querySelectorAll('.worker-candidate').forEach(chip => {
            const name = chip.getAttribute('data-name');
            if (selectedWorkerSet.has(name)) { chip.style.display = "none"; return; }
            chip.style.display = name.toLowerCase().includes(input) ? "inline-flex" : "none";
        });
    }
    function addWorkerToSelection(name) {
        selectedWorkerSet.add(name);
        document.querySelector(`.worker-candidate[data-name="${name}"]`).style.display = "none";
        renderSelectedBox();
    }
    function removeWorkerFromSelection(name) {
        selectedWorkerSet.delete(name);
        const cand = document.querySelector(`.worker-candidate[data-name="${name}"]`);
        if(cand) cand.style.display = "inline-flex";
        filterWorkerChips(); renderSelectedBox();
    }
    function renderSelectedBox() {
        const box = document.getElementById('selected-workers-box');
        const cnt = document.getElementById('worker-count-display');
        const list = Array.from(selectedWorkerSet);
        cnt.innerText = `(${list.length}ëª…)`;
        document.getElementById('sched-workers-text').value = list.join(', ');
        
        if (list.length === 0) box.innerHTML = '<span style="color:#aaa; font-size:0.8rem; padding:5px;">ì•„ë˜ ëª©ë¡ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”.</span>';
        else box.innerHTML = list.map(n => `<div class="chip" style="background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; gap:5px;">${n} <span onclick="removeWorkerFromSelection('${n}')" style="cursor:pointer; font-weight:bold;">&times;</span></div>`).join('');
    }

    // 6-3. ì°¨ëŸ‰ (ì¤‘ë³µ ì„ íƒ)
    const VEHICLE_LIST = ["1í˜¸ì°¨", "2í˜¸ì°¨", "3í˜¸ì°¨", "4í˜¸ì°¨", "ë³¸ì¸ì°¨"];
    function renderVehicleChips(currentVal) {
        const box = document.getElementById('car-chips-area');
        const selected = currentVal ? currentVal.split(',').map(s=>s.trim()) : [];
        if(box) box.innerHTML = VEHICLE_LIST.map(c => `<div class="chip ${selected.includes(c)?'active':''}" onclick="toggleCar(this, '${c}')">${c}</div>`).join('');
        document.getElementById('sched-car').value = currentVal;
    }
    function toggleCar(el, name) {
        el.classList.toggle('active');
        const all = document.querySelectorAll('#car-chips-area .chip.active');
        document.getElementById('sched-car').value = Array.from(all).map(c=>c.innerText).join(', ');
    }

    // 6-4. ê³µì • (íƒœê·¸ ë°©ì‹)
    const WORK_PRESETS = ["ì–‘ì¤‘", "í¬ì„¤", "ë‹¨ë§", "íŠ¸ë ˆì´", "ì…ì„ ", "ê²°ì„ ", "ìŠ¤í‹¸ë°°ê´€", "ë ˆì´ìŠ¤ì›¨ì´", "ì² ê±°", "ìì¬ì •ë¦¬", "ì²­ì†Œ"];
    function initWorkPresets(currentVal) {
        selectedWorkSet.clear();
        if(currentVal) currentVal.split(',').map(s=>s.trim()).forEach(t => { if(t) selectedWorkSet.add(t); });
        document.getElementById('new-work-input').value = "";
        renderWorkPresets();
    }
    function renderWorkPresets() {
        const pBox = document.getElementById('work-preset-list');
        const sBox = document.getElementById('selected-work-box');
        document.getElementById('sched-content').value = Array.from(selectedWorkSet).join(', ');

        if (selectedWorkSet.size === 0) sBox.innerHTML = '<span style="color:#aaa; font-size:0.8rem; padding:5px;">ê³µì •ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤.</span>';
        else sBox.innerHTML = Array.from(selectedWorkSet).map(t => `<div class="chip" style="background:#e0f2fe; color:#0369a1; border:1px solid #7dd3fc; gap:5px;">${t} <span onclick="removeWorkTag('${t}')" style="cursor:pointer; font-weight:bold;">&times;</span></div>`).join('');

        if(pBox) pBox.innerHTML = WORK_PRESETS.map(t => {
            const isSel = selectedWorkSet.has(t);
            return `<div class="chip" onclick="addWorkTag('${t}')" style="background:#f3f4f6; color:#555; display:${isSel?'none':'inline-flex'}">+ ${t}</div>`;
        }).join('');
    }
    function addWorkTag(t) { selectedWorkSet.add(t); renderWorkPresets(); }
    function removeWorkTag(t) { selectedWorkSet.delete(t); renderWorkPresets(); }
    function addNewWorkTag() {
        const inp = document.getElementById('new-work-input');
        const val = inp.value.trim();
        if(val) { selectedWorkSet.add(val); inp.value = ""; renderWorkPresets(); }
    }

    // [7] ì €ì¥/ì‚­ì œ ë° ê¸°íƒ€
    async function saveSchedule(mode) {
        const payload = {
            date: document.getElementById('sched-date').value,
            client: document.getElementById('sched-client').value,
            site: document.getElementById('sched-site').value,
            shift: document.getElementById('sched-shift').value,
            workers: document.getElementById('sched-workers-text').value,
            car: document.getElementById('sched-car').value,
            content: document.getElementById('sched-content').value,
            note: document.getElementById('sched-note').value
        };
        if(!payload.client || !payload.site) return alert("ê±°ë˜ì²˜ì™€ í˜„ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");

        let action = 'addSchedule';
        let dataToSend = payload;
        const endDateStr = document.getElementById('sched-end-date').value;

        if (mode === 'add' && endDateStr) {
            action = 'addScheduleBatch';
            const list = [];
            let cur = new Date(payload.date);
            const end = new Date(endDateStr);
            while(cur < end) {
                list.push({...payload, date: cur.toISOString().split('T')[0]});
                cur.setDate(cur.getDate()+1);
            }
            dataToSend = list;
        } else if (mode === 'update') {
            action = 'updateSchedule';
            payload.rowId = document.getElementById('sched-row-id').value;
        }
        await sendToGas(action, dataToSend);
        closeModal();
    }
    async function deleteSchedule() {
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const rowId = document.getElementById('sched-row-id').value;
        await sendToGas('deleteSchedule', { rowId });
        closeModal();
    }

    // UI Helper
    const SHIFT_TYPES = ['ì£¼ê°„', 'ì•¼ê°„', 'ì¡°ì¶œ'];
    let currentShiftIndex = 0;
    function toggleShift() { currentShiftIndex = (currentShiftIndex + 1) % SHIFT_TYPES.length; updateShiftBtn(); }
    function updateShiftBtn() {
        const s = SHIFT_TYPES[currentShiftIndex];
        document.getElementById('sched-shift').value = s;
        const btn = document.getElementById('shift-toggle-btn');
        btn.innerText = (s === 'ì£¼ê°„' ? 'ğŸŒ ' : s === 'ì•¼ê°„' ? 'ğŸŒ™ ' : 'ğŸŒ… ') + s;
        btn.style.backgroundColor = s === 'ì£¼ê°„' ? '#3b82f6' : (s === 'ì•¼ê°„' ? '#475569' : '#f59e0b');
    }

    // ì„œë²„ í†µì‹ 
    async function sendToGas(action, data) {
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action, data }), redirect: 'follow' });
            const text = await res.text();
            if (text.includes("SUCCESS")) {
                alert("âœ… ì™„ë£Œ!");
                if(action.includes('Schedule')) { await loadScheduleData(); initCalendar(); renderScheduleList(); }
                else if(action.includes('Worker')) loadAdminData();
                else loadClientManagement();
                
                if(action === 'adminAddClient') { document.getElementById('c_client').value = ""; document.getElementById('c_site').value = ""; document.getElementById('c_addr').value = ""; }
            } else alert("âš ï¸ " + text);
        } catch (e) { alert("í†µì‹  ì—ëŸ¬: " + e.message); }
    }

    async function loadScheduleData() { const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getScheduleList' }) }); globalScheduleData = await res.json(); }
    async function loadAdminData() { const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllWorkerInfo' }) }); globalWorkerData = await res.json(); document.getElementById('worker-list-admin').innerHTML = globalWorkerData.map(w => `<div class="worker-card" style="border-top-color:${w.status==='ì¬ì§'?'#2563eb':'#ef4444'}"><div style="display:flex; justify-content:space-between;"><b>${w.name}</b> <span class="status-badge ${w.status==='ì¬ì§'?'status-on':'status-off'}">${w.status}</span></div><div>${w.phone||'-'}</div></div>`).join(''); }
    async function loadClientManagement() {
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getClientListData' }) });
        globalClientData = await res.json();
        const cBox = document.getElementById('client-chips');
        if(cBox) cBox.innerHTML = [...new Set(globalClientData.map(i=>i.client))].map(c => `<div class="chip" onclick="selectClientChip(this, '${c}')">${c}</div>`).join('');
        renderClientList(globalClientData);
    }
    
    function renderClientList(data) {
        const box = document.getElementById('client-management-list');
        const grouped = data.reduce((acc, curr) => { if (!acc[curr.client]) acc[curr.client] = []; acc[curr.client].push(curr); return acc; }, {});
        box.innerHTML = '<div class="swiper client-management-swiper"><div class="swiper-wrapper">' + 
            Object.keys(grouped).map(c => `<div class="swiper-slide client-slide"><div class="client-card"><div class="client-header">ğŸ¢ ${c}</div><div class="site-list">${grouped[c].map(s=>`<div class="site-row"><div class="site-name">${s.site}</div><div class="site-action"><button class="status-btn ${s.status==='ì™„ë£Œ'?'completed':'ing'}" onclick="toggleSiteStatus('${c}','${s.site}','${s.status}')">${s.status||'ì§„í–‰ì¤‘'}</button></div></div>`).join('')}</div></div></div>`).join('') + 
            '</div></div>';
        if(window.clientSwiper) window.clientSwiper.destroy();
        window.clientSwiper = new Swiper('.client-management-swiper', { slidesPerView:'auto', centeredSlides:true, spaceBetween:15, nested:true });
    }

    // ê¸°íƒ€ ê¸°ëŠ¥ í•¨ìˆ˜
    function addWorker() { const d = { name: document.getElementById('new-name').value, role: document.getElementById('new-role').value, rate: document.getElementById('new-rate').value, pw: document.getElementById('new-pw').value, phone: document.getElementById('new-phone').value, address: document.getElementById('new-address').value }; sendToGas('adminAddWorker', d); }
    function saveClient() { const d = { client: document.getElementById('c_client').value, site: document.getElementById('c_site').value, address: document.getElementById('c_addr').value }; sendToGas('adminAddClient', d); }
    function selectClientChip(el, name) { document.getElementById('c_client').value = name; }
    function saveMaterial() { const d = { cat: document.getElementById('m_cat').value, name: document.getElementById('m_name').value, spec: document.getElementById('m_spec').value, unit: document.getElementById('m_unit').value, price: document.getElementById('m_price').value }; sendToGas('adminAddMaterial', d); }
    async function toggleSiteStatus(c, s, st) { if (confirm("ìƒíƒœë³€ê²½?")) await sendToGas('updateSiteStatus', { client: c, site: s, status: st==='ì™„ë£Œ'?'ì§„í–‰ì¤‘':'ì™„ë£Œ' }); }
    async function editAddress(c, s, a) { const n = prompt("ì£¼ì†Œ:", a); if (n) await sendToGas('updateSiteAddress', { client: c, site: s, address: n }); }
    async function changePassword(n) { const p = prompt("ìƒˆ ë¹„ë²ˆ:"); if (p) await sendToGas('adminUpdatePassword', { userName: n, newPw: p }); }
    async function updateStatus(n, s) { if (confirm("ìƒíƒœë³€ê²½?")) await sendToGas('adminUpdateStatus', { userName: n, status: s }); }
    function copyText(t) { navigator.clipboard.writeText(t); alert("ë³µì‚¬ë¨"); }
    </script>
</body>
</html>
